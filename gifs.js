const gifDatabase = [
    {
        src: './gifs/Eclipse.gif',
        tags: ['astrology', 'dark'],
        alt: 'Eclipse GIF'
    },
    {
        src: './gifs/Leoin5ft6.gif',
        tags: ['astrology', 'funny'],
        alt: 'Leo Pokemon GIF'
    },
    {
        src: './gifs/Ratss.gif',
        tags: ['animals', 'funny'],
        alt: 'Rats Pokemon GIF'
    },
    {
        src: './gifs/RUN.gif',
        tags: ['animals', 'funny'],
        alt: 'Running GIF'
    },
    {
        src: './gifs/Vape.gif',
        tags: ['funny', 'humans'],
        alt: 'Vape GIF'
    },
    {
        src: './gifs/Wink.gif',
        tags: ['dark', 'humans'],
        alt: 'Winking GIF'
    },
    {
        src: '../gifs/pokemon/1.gif',
        tags: ['pokemon', 'games'],
        alt: 'Eerie character with a weezing'
    },
    {
        src: '../gifs/pokemon/2HAI.gif',
        tags: ['pokemon', 'games'],
        alt: 'Two sudowoodos'
    },
    {
        src: '../gifs/pokemon/1313.gif',
        tags: ['pokemon', 'games', 'cartoons'],
        alt: 'Blassing for shinnies'
    },
    {
        src: '../gifs/pokemon/3213.gif',
        tags: ['pokemon', 'games'],
        alt: 'Meerie christmas'
    },
    {
        src: '../gifs/pokemon/AlphaCatching.gif',
        tags: ['pokemon', 'cartoons'],
        alt: 'Pokemon breaks out of ball'
    },
    {
        src: '../gifs/pokemon/AlphasPart2.gif',
        tags: ['pokemon', 'cartoons'],
        alt: 'Gengar wont get caught'
    },
    {
        src: '../gifs/pokemon/AmorFati.gif',
        tags: ['pokemon', 'games'],
        alt: 'Luigi seed'
    },
    {
        src: '../gifs/pokemon/ded.gif',
        tags: ['cartoons', 'funny'],
        alt: 'Family guy freak out'
    },
    {
        src: '../gifs/pokemon/EMF2.gif',
        tags: ['cartoons', 'funny', 'pokemon', 'dark'],
        alt: 'ahhhh'
    },
    {
        src: '../gifs/pokemon/fallingasleep.gif',
        tags: ['cartoons', 'pokemon'],
        alt: 'ur falling asleep'
    },
    {
        src: '../gifs/pokemon/bidoof.gif',
        tags: ['cartoons', 'pokemon'],
        alt: 'bidoof'
    },
    {
        src: '../gifs/pokemon/spinda.gif',
        tags: ['cartoons', 'pokemon'],
        alt: 'spinda with a flower'
    },
    {
        src: '../gifs/pokemon/funnybidoof.gif',
        tags: ['cartoons', 'funny', 'pokemon'],
        alt: 'scared bidoof'
    },
    {
        src: '../gifs/pokemon/zor.gif',
        tags: ['cartoons', 'pokemon'],
        alt: 'scared bidoof'
    },
    {
        src: '../gifs/pokemon/tshark.gif',
        tags: ['cartoons', 'pokemon'],
        alt: 'lil guy'
    },
    {
        src: '../gifs/pokemon/tbidoofs.gif',
        tags: ['cartoons', 'pokemon'],
        alt: 'scared bidoof'
    },
    {
        src: '../gifs/pokemon/gassy.gif',
        tags: ['cartoons', 'funny', 'pokemon'],
        alt: 'gassy gastrodon'
    },
    {
        src: './gifs/2wtf.gif',
        tags: ['funny', 'humans', 'dark'],
        alt: 'wtf'
    },
    {
        src: './gifs/3wtf.gif',
        tags: ['humans', 'funny', 'dark'],
        alt: 'wtf'
    },
    {
        src: './gifs/8H-02.gif',
        tags: ['animals'],
        alt: 'ants'
    },
    {
        src: './gifs/8H.gif',
        tags: ['animals'],
        alt: 'ant face'
    },
    {
        src: './gifs/AHHHH.gif',
        tags: ['funny', 'animals'],
        alt: 'ahhhhh'
    },
    {
        src: './gifs/AnalWarts.gif',
        tags: ['funny', 'humans', 'dark'],
        alt: 'anal warts'
    },
    {
        src: './gifs/APM.gif',
        tags: ['games', 'humans'],
        alt: 'so fast'
    },
    {
        src: './gifs/APM2.gif',
        tags: ['games', 'humans'],
        alt: 'so fast'
    },
    {
        src: './gifs/APM3.gif',
        tags: ['games', 'humans'],
        alt: 'so fast'
    },
    {
        src: './gifs/AstroReading.gif',
        tags: ['severance', 'humans', 'dark', 'funny'],
        alt: 'like that'
    },
    {
        src: './gifs/BeefMilk.gif',
        tags: ['funny', 'humans'],
        alt: 'beef milk'
    },
    {
        src: './gifs/BeNotAfraid.gif',
        tags: ['dark'],
        alt: 'an angel'
    },
    {
        src: './gifs/Bojack-horseman-worried.gif',
        tags: ['dark', 'cartoons'],
        alt: 'sad bojack'
    },
    {
        src: './gifs/Boohoo.gif',
        tags: ['funny', 'humans'],
        alt: 'ouch'
    },
    {
        src: './gifs/BrainRot.gif',
        tags: ['dark', 'humans', 'severance'],
        alt: 'ew'
    },
    {
        src: './gifs/ButtholeSrufer.gif',
        tags: ['funny', 'animals'],
        alt: 'oook'
    },
    {
        src: './gifs/CalebHammer.gif',
        tags: ['funny', 'humans'],
        alt: 'ahh'
    },
    {
        src: './gifs/CarOnFire.gif',
        tags: ['funny', 'humans'],
        alt: 'its on fireee'
    },
    {
        src: './gifs/Copium.gif',
        tags: ['funny', 'humans', 'dark'],
        alt: 'cope'
    },
    {
        src: './gifs/Copium2.gif',
        tags: ['funny', 'humans', 'dark'],
        alt: 'cope'
    },
    {
        src: './gifs/Coward.gif',
        tags: ['funny', 'humans'],
        alt: 'would a coward have this?'
    },
    {
        src: './gifs/ded01.gif',
        tags: ['funny', 'animals'],
        alt: 'sphincturing'
    },
    {
        src: './gifs/ded22.gif',
        tags: ['funny', 'humans', 'cartoons'],
        alt: 'twister yess'
    },
    {
        src: './gifs/Depression.gif',
        tags: ['funny', 'cartoons', 'dark'],
        alt: 'ahahahaha'
    },
    {
        src: './gifs/devourfeculance.gif',
        tags: ['funny', 'humans', 'dark', 'severance'],
        alt: 'devour feculance'
    },
    {
        src: './gifs/dUNCE.gif',
        tags: ['funny', 'humans'],
        alt: 'dunce'
    },
    {
        src: './gifs/Egg.gif',
        tags: ['animals'],
        alt: 'egg'
    },
    {
        src: './gifs/EMF.gif',
        tags: ['funny', 'humans', 'dark'],
        alt: 'ow'
    },
    {
        src: './gifs/Eruption.gif',
        tags: ['funny'],
        alt: 'eruption'
    },
    {
        src: './gifs/Facepalm.gif',
        tags: ['funny', 'humans'],
        alt: 'ow'
    },
    {
        src: './gifs/fallout-vault-boy.gif',
        tags: ['funny', 'cartoons', 'games'],
        alt: 'Fallout boy'
    },
    {
        src: './gifs/FuckTesla.gif',
        tags: ['funny', 'humans'],
        alt: 'ew a tesla'
    },
    {
        src: './gifs/GimmieDat.gif',
        tags: ['dark', 'animals'],
        alt: 'eating'
    },
    {
        src: './gifs/Goddamninternet.gif',
        tags: ['funny', 'humans'],
        alt: 'goddamn internet'
    },
    {
        src: './gifs/GTFO.gif',
        tags: ['funny', 'animals'],
        alt: 'runnnn'
    },
    {
        src: './gifs/guns.gif',
        tags: ['dark', 'humans'],
        alt: 'guns'
    },
    {
        src: './gifs/HAI.gif',
        tags: ['funny', 'humans', 'dark'],
        alt: 'ahhhh'
    },
    {
        src: './gifs/Heartbreak.gif',
        tags: ['dark', 'cartoons', 'pokemon'],
        alt: 'poor guy :('
    },
    {
        src: './gifs/Helppp.gif',
        tags: ['funny', 'humans', 'animals'],
        alt: 'helpppp'
    },
    {
        src: './gifs/intotheabyss.gif',
        tags: ['funny', 'humans'],
        alt: 'into the abyss'
    },
    {
        src: './gifs/IThou.gif',
        tags: ['funny', 'animals'],
        alt: 'who dat'
    },
    {
        src: './gifs/Love.gif',
        tags: ['funny', 'humans'],
        alt: 'explain pants'
    },
    {
        src: './gifs/MarthaMary.gif',
        tags: ['funny', 'humans'],
        alt: 'martha and mary'
    },
    {
        src: './gifs/Mayonaise.gif',
        tags: ['funny', 'humans'],
        alt: 'mayonaise'
    },
    {
        src: './gifs/me-when-the-me.gif',
        tags: ['funny', 'animals', 'dark'],
        alt: 'boiled'
    },
    {
        src: './gifs/MeatAndPotatoes.gif',
        tags: ['funny', 'humans'],
        alt: 'a good potato'
    },
    {
        src: './gifs/NDA.gif',
        tags: ['funny', 'humans', 'dark'],
        alt: 'mandatory nda'
    },
    {
        src: './gifs/NoEmf.gif',
        tags: ['funny', 'humans'],
        alt: 'no more emfs'
    },
    {
        src: './gifs/OhMaGod.gif',
        tags: ['funny', 'humans'],
        alt: 'omgg'
    },
    {
        src: './gifs/Ohno!!!.gif',
        tags: ['funny', 'humans'],
        alt: 'oh nooo'
    },
    {
        src: './gifs/poe.gif',
        tags: ['games'],
        alt: 'POE'
    },
    {
        src: './gifs/poop.gif',
        tags: ['funny', 'humans'],
        alt: 'splash'
    },
    {
        src: './gifs/pulloutking.gif',
        tags: ['funny', 'humans'],
        alt: 'pull out king'
    },
    {
        src: './gifs/QQ.gif',
        tags: ['funny', 'humans'],
        alt: 'lol'
    },
    {
        src: './gifs/RACOONS.gif',
        tags: ['animals', 'humans'],
        alt: 'raccoons'
    },
    {
        src: './gifs/RACOONS2.gif',
        tags: ['animals', 'humans'],
        alt: 'raccoons'
    },
    {
        src: './gifs/RACOONS3.gif',
        tags: ['animals', 'humans'],
        alt: 'raccoons'
    },
    {
        src: './gifs/RACOONS4.gif',
        tags: ['animals', 'cartoons'],
        alt: 'raccoons'
    },
    {
        src: './gifs/RACOONS5.gif',
        tags: ['animals', 'cartoons'],
        alt: 'raccoons'
    },
    {
        src: './gifs/Rafrafaraf.gif',
        tags: ['funny', 'humans'],
        alt: 'ahhhh'
    },
    {
        src: './gifs/SadnessCheck.gif',
        tags: ['funny', 'humans'],
        alt: 'sad burrito'
    },
    {
        src: './gifs/Saturn.gif',
        tags: ['humans', 'funny', 'dark'],
        alt: 'saturned'
    },
    {
        src: './gifs/SaturnIngress.gif',
        tags: ['animals', 'dark'],
        alt: 'ahhh a croc'
    },
    {
        src: './gifs/Screenshot_2024-08-25_111411.jpg',
        tags: ['humans', 'funny', 'dark'],
        alt: 'raccoons'
    },
    {
        src: './gifs/Selfie.gif',
        tags: ['animals', 'humans'],
        alt: 'selfieee'
    },
    {
        src: './gifs/SharkCuddle.gif',
        tags: ['animals', 'humans'],
        alt: 'good boy'
    },
    {
        src: './gifs/SheUgl.gif',
        tags: ['humans', 'funny'],
        alt: 'she ugly'
    },
    {
        src: './gifs/Shunting.gif',
        tags: ['animals', 'pokemon'],
        alt: 'wheres the shiny'
    },
    {
        src: './gifs/SPAGHETTI.gif',
        tags: ['humans', 'funny'],
        alt: 'yumm'
    },
    {
        src: './gifs/STOPIT5G.gif',
        tags: ['humans', 'dark', 'funny'],
        alt: 'crush'
    },
    {
        src: './gifs/SwansonVsEMF.gif',
        tags: ['humans', 'funny'],
        alt: 'get outta here'
    },
    {
        src: './gifs/TheSuniscrazy.gif',
        tags: ['humans', 'dark', 'funny'],
        alt: 'ahhh'
    },
    {
        src: './gifs/tolerance.gif',
        tags: ['humans', 'dark', 'funny'],
        alt: 'ahhh'
    },
    {
        src: './gifs/Try1.gif',
        tags: ['humans', 'funny'],
        alt: 'ahhh'
    },
    {
        src: './gifs/tumblr_n9os5hate21ry46hlo1_500-1370067451.gif',
        tags: ['humans', 'funny'],
        alt: 'pullout king'
    },
    {
        src: './gifs/WHY.gif',
        tags: ['humans', 'funny'],
        alt: 'WHY'
    },
    {
        src: './gifs/WHY1.gif',
        tags: ['humans', 'funny'],
        alt: 'WHY'
    },
    {
        src: './gifs/Wtf.gif',
        tags: ['humans', 'funny'],
        alt: 'wtf'
    },
    {
        src: './gifs/WTFWHY.gif',
        tags: ['humans', 'funny'],
        alt: 'WHY'
    },
];

let currentGifIndex = 0;
// Shuffled order used specifically for the header cycling
let headerGifOrder = [];

function initHeaderOrder() {
    // try to restore from sessionStorage first
    const stored = loadHeaderOrderFromStorage();
    if (stored && stored.length) {
        // map stored srcs back to gif objects in the database (preserve objects)
        headerGifOrder = stored.map(src => gifDatabase.find(g => normalizePath(g.src) === src)).filter(Boolean);
    }

    // if no valid stored order, create a shuffled copy for header rotation so page lists remain deterministic
    if (!headerGifOrder || !headerGifOrder.length) {
        headerGifOrder = shuffleArray([...gifDatabase]);
        saveHeaderOrderToStorage(headerGifOrder);
    }

    currentGifIndex = -1; // start before first so first call shows index 0
}

function saveHeaderOrderToStorage(order) {
    try {
        const srcs = order.map(g => normalizePath(g.src));
        sessionStorage.setItem('headerGifOrder', JSON.stringify(srcs));
    } catch (e) {
        // ignore storage errors (e.g., privacy mode)
    }
}

function loadHeaderOrderFromStorage() {
    try {
        const raw = sessionStorage.getItem('headerGifOrder');
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return null;
        return parsed;
    } catch (e) {
        return null;
    }
}

// Optional helper to clear persisted header order (exposed for debugging)
function clearHeaderOrderStorage() {
    try { sessionStorage.removeItem('headerGifOrder'); } catch (e) {}
}

// Normalize paths so leading slash doesn't break local file loading (file://)
function normalizePath(src) {
    if (!src) return src;
    // Remove leading slash if present
    src = src.startsWith('/') ? src.slice(1) : src;
    // Add ./ if not already present
    return src.startsWith('./') ? src : './' + src;
}

function cycleHeaderBackground() {
    const header = document.querySelector('.header');
    if (!header) return;
    // fallback to full database if headerGifOrder is not initialized
    const source = (headerGifOrder && headerGifOrder.length) ? headerGifOrder : gifDatabase;
    currentGifIndex = (currentGifIndex + 1) % source.length;
    const bg = normalizePath(source[currentGifIndex].src);
    header.style.backgroundImage = `url(${bg})`;
    header.style.backgroundSize = 'cover';
    header.style.backgroundPosition = 'center';
}

// Function to create a GIF post element
function createGifPost(gif) {
    const post = document.createElement('div');
    post.className = 'post';
    const content = document.createElement('div');
    content.className = 'post-content';

    const img = document.createElement('img');
    img.alt = gif.alt || '';

    // When image loads, add loaded class to trigger CSS fade
    img.addEventListener('load', () => {
        img.classList.add('loaded');
    });

    // Set src after attaching load handler to ensure cached images still trigger
    img.src = normalizePath(gif.src);

    content.appendChild(img);
    post.appendChild(content);

    // Add click handler for fullscreen view in grid mode
    post.addEventListener('click', () => {
        if (document.querySelector('.main').classList.contains('grid-view')) {
            showFullscreen(gif.src);
        }
    });

    return post;
}

// Play reveal animation for a list of posts inside main container
function playRevealAnimation(container) {
    const posts = Array.from(container.querySelectorAll('.post'));
    const isGrid = container.classList.contains('grid-view');
    const baseDelay = isGrid ? 60 : 30; // ms per item
    const transitionMs = 600; // should match CSS transition duration

    posts.forEach((post, i) => {
        // ensure overlay covers the post and image hidden initially
        post.classList.remove('reveal');
        post.classList.add('revealing');

        const img = post.querySelector('img');
        // compute delay - must match the delay applied inline during creation
        const delayMs = i * baseDelay;
        // ensure the img transitionDelay is set according to current layout
        if (img) {
            img.style.transitionDelay = `${delayMs}ms`;
            // If the image is already loaded (cached), remove the 'loaded' class briefly
            // so we can re-trigger the CSS transition when we want to reveal it.
            if (img.complete && img.classList.contains('loaded')) {
                img.classList.remove('loaded');
                // force reflow so removing 'loaded' takes effect
                // eslint-disable-next-line no-unused-expressions
                img.offsetHeight;
            }
        }

        // schedule reveal: wait for the inline delay (to let image become visible),
        // then wait transition duration and mark reveal complete
        setTimeout(() => {
            if (img) {
                if (img.complete) {
                    // trigger the image transition and then remove overlay
                    img.classList.add('loaded');
                    post.classList.add('reveal');
                    post.classList.remove('revealing');
                } else {
                    // wait for load, then trigger
                    const onLoad = () => {
                        img.classList.add('loaded');
                        post.classList.add('reveal');
                        post.classList.remove('revealing');
                        img.removeEventListener('load', onLoad);
                    };
                    img.addEventListener('load', onLoad);
                }
            } else {
                post.classList.add('reveal');
                post.classList.remove('revealing');
            }
        }, delayMs + 40); // small extra to ensure inline transitionDelay has been applied
    });
}

// Function to show fullscreen view
function showFullscreen(src) {
    let fullscreenView = document.querySelector('.fullscreen-view');
    
    // Create fullscreen view if it doesn't exist
    if (!fullscreenView) {
        fullscreenView = document.createElement('div');
        fullscreenView.className = 'fullscreen-view';
        fullscreenView.innerHTML = '<img src="" alt="Fullscreen GIF">';
        document.body.appendChild(fullscreenView);
        
        // Close fullscreen view when clicked
        fullscreenView.addEventListener('click', () => {
            fullscreenView.classList.remove('active');
        });
    }

    // Set the image source (normalize path) and show the fullscreen view
    fullscreenView.querySelector('img').src = normalizePath(src);
    fullscreenView.classList.add('active');
}
// Function to toggle view mode
function toggleView(mode) {
    const mainContainer = document.querySelector('.main');
    const listBtn = document.querySelector('.list-view-btn');
    const gridBtn = document.querySelector('.grid-view-btn');
    
    if (mode === 'grid') {
        mainContainer.classList.remove('list-view');
        mainContainer.classList.add('grid-view');
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
        // replay reveal when switching views
        playRevealAnimation(mainContainer);
    } else {
        mainContainer.classList.remove('grid-view');
        mainContainer.classList.add('list-view');
        listBtn.classList.add('active');
        gridBtn.classList.remove('active');
        // replay reveal when switching views
        playRevealAnimation(mainContainer);
    }
}

// Fisher-Yates shuffle algorithm
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// Function to display GIFs based on selected tag
function filterGifs(tag, randomize = false) {
    const mainContainer = document.querySelector('.main');
    mainContainer.innerHTML = ''; // Clear current posts

    let filteredGifs = tag === 'all' 
        ? [...gifDatabase] 
        : gifDatabase.filter(gif => gif.tags.includes(tag));

    // If randomize is true, shuffle the filtered GIFs
    if (randomize) {
        filteredGifs = shuffleArray(filteredGifs);
    }

    // Append posts with a staggered delay for a ripple effect
    filteredGifs.forEach((gif, i) => {
        const post = createGifPost(gif);

        // Set a staggered transition delay on the image so they fade in in sequence
        const img = post.querySelector('img');
        if (img) {
            // Use larger spacing for grid, tighter for list
            const isGrid = mainContainer.classList.contains('grid-view');
            const delayMs = isGrid ? i * 60 : i * 30;
            img.style.transitionDelay = `${delayMs}ms`;
        }
        // start with overlay active; reveal will be triggered after append
        post.classList.add('revealing');
        mainContainer.appendChild(post);
    });

    // after appending all posts, play the reveal animation (staggered)
    playRevealAnimation(mainContainer);
}

// Initialize the page
document.addEventListener('DOMContentLoaded', () => {
    // Set up header background cycling
    // initialize shuffled header order and start cycling
    initHeaderOrder();
    cycleHeaderBackground();
    setInterval(cycleHeaderBackground, 5000);

    // Default to grid view and show all GIFs initially (randomized)
    toggleView('grid');
    filterGifs('all', true);

    // Set up navigation click handlers
    document.querySelectorAll('.nav a').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const href = e.target.getAttribute('href').replace('#', '');
            if (href === 'random') {
                // If it's the random button, show all GIFs in random order
                const shuffledGifs = [...gifDatabase].sort(() => Math.random() - 0.5);
                const mainContainer = document.querySelector('.main');
                mainContainer.innerHTML = '';
                shuffledGifs.forEach((gif, i) => {
                    const post = createGifPost(gif);
                    // inline delay to match filterGifs behavior
                    const delayMs = mainContainer.classList.contains('grid-view') ? i * 60 : i * 30;
                    const img = post.querySelector('img');
                    if (img) img.style.transitionDelay = `${delayMs}ms`;
                    post.classList.add('revealing');
                    mainContainer.appendChild(post);
                });
                playRevealAnimation(mainContainer);
            } else {
                // Otherwise filter by tag
                filterGifs(href === '' ? 'all' : href);
            }
        });
    });

    // Set up view toggle handlers (single binding)
    const listBtn = document.querySelector('.list-view-btn');
    const gridBtn = document.querySelector('.grid-view-btn');
    if (listBtn) listBtn.addEventListener('click', () => toggleView('list'));
    if (gridBtn) gridBtn.addEventListener('click', () => toggleView('grid'));
});